=== modified file 'rootstock'
--- rootstock	2011-02-28 06:06:33 +0000
+++ rootstock	2011-02-28 14:56:34 +0000
@@ -4,6 +4,7 @@
 #
 #  Author: Oliver Grawert <ogra@canonical.com>
 #          Ricardo Salveti <ricardo.salveti@canonical.com>
+#          Svein Seldal <sveinse@seldal.com>
 #
 #  This program is free software; you can redistribute it and/or
 #  modify it under the terms of the GNU General Public License as
@@ -204,7 +205,11 @@
     additional mirror to use
 --no-root
     run rootstock without requiring root access (slower as uses a full vm)
-
+--sources <filename>
+    Use <filename> as target apt sources.list file
+--apt-upgrade
+    run apt-upgrade after bootstrapping. Useful if multple apt sources are provided
+    with --sources or --extra-mirror
 Examples:
 
 Xubuntu-Desktop (as root): rootstock -f host -l user -p temppwd -i 2G -s xubuntu-desktop
@@ -639,11 +644,6 @@
     APT_FORCE="--allow-unauthenticated"
 }
 
-add_extra_mirror()
-{
-    EXRA_MIRROR_CMD="echo \"deb ${EXTRAMIRROR} ${DIST} ${COMPONENTS}\" >>/etc/apt/sources.list"
-}
-
 roll_tarball()
 {
     # create a rootfs tgz
@@ -705,6 +705,9 @@
 MIRROR="http://ports.ubuntu.com/ubuntu-ports"
 COMPONENTS="main universe"
 
+# User-specified sources file
+USER_SOURCES=""
+
 # user-specified script
 USER_SCRIPT=""
 
@@ -730,6 +733,7 @@
 
 PACKAGE_CLEANUP="apt-get clean"
 PACKAGE_CLEANUP_SUB="${PACKAGE_CLEANUP}"
+APT_UPGRADE=""
 APT_UPDATE="apt-get update"
 APT_FORCE=""
 EXRA_MIRROR_CMD=""
@@ -739,8 +743,8 @@
 GETOPT=`getopt -o hf:l:p:n:s:i:g:m:c:t:x:d:q --long help,fqdn:,login:,\
 password:,fullname:,seed:,imagesize:,manifest:,mirror:,components:,timezone:,\
 kblayout:,kbmodel:,kbvariant:,kboptions:,locale:,keepimage,notarball,script:,\
-serial:,doswap,swapsize:,dist:,quiet,kernel-image:,copy-package-cache,\
-restore-package-cache,clean-package-cache,extra-mirror:,no-root,version \
+serial:,sources:,doswap,swapsize:,dist:,quiet,kernel-image:,copy-package-cache,\
+restore-package-cache,clean-package-cache,extra-mirror:,no-root,version,apt-upgrade \
 -n "$PROGRAM" -- "$@"`
 if [ $? != 0 ]; then usage; exit 1; fi
 eval set -- "$GETOPT"
@@ -843,6 +847,14 @@
             SERIAL=1
             shift 2
             ;;
+        --sources)
+            USER_SOURCES="$2"
+            shift 2
+            ;;
+        --apt-upgrade)
+            APT_UPGRADE="apt-get upgrade -y"
+            shift
+            ;;
         --doswap)
             NOSWAP=""
             shift
@@ -1008,10 +1020,6 @@
     restore_package_cache
 fi
 
-if [ "$EXTRAMIRROR" ];then
-    add_extra_mirror
-fi
-
 # basic fstab
 echo "proc /proc proc defaults 0 0" >$ROOTFS/etc/fstab
 if [ "$KEEPIMAGE" ];then
@@ -1090,9 +1098,6 @@
 
 ${SWAPCMD}
 
-echo "deb ${MIRROR} ${DIST} ${COMPONENTS}" >/etc/apt/sources.list
-echo "deb ${MIRROR} ${DIST}-updates ${COMPONENTS}" >>/etc/apt/sources.list
-${EXRA_MIRROR_CMD}
 
 if [ "$RUNVM" ];then
     ifconfig lo up
@@ -1115,6 +1120,7 @@
 groupadd fuse || true
 
 ${APT_UPDATE}
+${APT_UPGRADE}
 
 ${PACKAGE_CLEANUP}
 
@@ -1173,6 +1179,20 @@
 
 EOF
 
+if [ "$USER_SOURCES" ]; then
+	# Copy user provided sources file
+    cp "$USER_SOURCES" "$ROOTFS/etc/apt/sources.list"
+else
+	# Use system default deb source
+    echo "deb ${MIRROR} ${DIST} ${COMPONENTS}" >$ROOTFS/etc/apt/sources.list
+    echo "deb ${MIRROR} ${DIST}-updates ${COMPONENTS}" >>$ROOTFS/etc/apt/sources.list
+
+	# Add extra debsource
+    if [ "$EXTRAMIRROR" ];then
+        echo "deb ${EXTRAMIRROR} ${DIST} ${COMPONENTS}" >>$ROOTFS/etc/apt/sources.list
+    fi
+fi
+
 # copy over user script
 if [ "$USER_SCRIPT" ]; then
     cp "$USER_SCRIPT" "$ROOTFS/rootstock-user-script"

=== modified file 'rootstock.1'
--- rootstock.1	2010-08-02 13:56:53 +0000
+++ rootstock.1	2011-02-28 14:55:07 +0000
@@ -1,5 +1,5 @@
 .\" DO NOT MODIFY THIS FILE!  It was generated by help2man 1.38.2.
-.TH ROOTSTOCK "1" "August 2010" "rootstock 0.1.99.4" "User Commands"
+.TH ROOTSTOCK "1" "January 2011" "rootstock 0.1.99.4" "User Commands"
 .SH NAME
 rootstock \- manual page for rootstock 0.1.99.4
 .SH SYNOPSIS
@@ -167,6 +167,15 @@
 \fB\-\-no\-root\fR
 .IP
 run rootstock without requiring root access (slower as uses a full vm)
+.PP
+\fB\-\-sources\fR <filename>
+.IP
+Use <filename> as target apt sources.list file
+.PP
+\fB\-\-apt\-upgrade\fR
+.IP
+run apt\-upgrade after bootstrapping. Useful if multple apt sources are provided
+with \fB\-\-sources\fR or \fB\-\-extra\-mirror\fR
 .SH EXAMPLES
 
 Xubuntu\-Desktop (as root): rootstock \fB\-f\fR host \fB\-l\fR user \fB\-p\fR temppwd \fB\-i\fR 2G \fB\-s\fR xubuntu\-desktop
@@ -186,3 +195,15 @@
 .br
 This is free software: you are free to change and redistribute it.
 There is NO WARRANTY, to the extent permitted by law.
+.SH "SEE ALSO"
+The full documentation for
+.B rootstock
+is maintained as a Texinfo manual.  If the
+.B info
+and
+.B rootstock
+programs are properly installed at your site, the command
+.IP
+.B info rootstock
+.PP
+should give you access to the complete manual.

